{% extends 'base.html' %}
{% load static %}
{% block content %}

<h2>Panel Operador - GestiÃ³n de Incidentes</h2>
<hr>

<!-- ================= REGISTRAR INCIDENTE ================= -->
<h3>Registrar Incidente</h3>

<select id="tipo"></select>
<select id="severidad"></select>
<select id="estado"></select>

<input id="lat" placeholder="Latitud">
<input id="lng" placeholder="Longitud">

<textarea id="desc" placeholder="DescripciÃ³n"></textarea>

<input type="file" id="evidencia">

<button onclick="crearIncidente()">Registrar</button>

<hr>

<!-- ================= LISTADO ================= -->
<h3>Listado de Incidentes</h3>

<table border="1" width="100%">
<thead>
<tr>
<th>ID</th>
<th>Tipo</th>
<th>Severidad</th>
<th>Estado</th>
<th>UbicaciÃ³n</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>


<!-- MODAL ASIGNAR RECURSOS -->
<div class="modal fade" id="modalAsignar" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Asignar recursos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <p>Seleccione los recursos disponibles:</p>

        <div id="listaRecursos" class="row g-2"></div>

      </div>

      <div class="modal-footer">
        <button 
          type="button" 
          class="btn btn-secondary" 
          data-bs-dismiss="modal">
          Cancelar
        </button>

        <button 
          type="button" 
          class="btn btn-primary"
          onclick="confirmarAsignacion()">
          Asignar
        </button>
      </div>

    </div>
  </div>
</div>


<script>
// ================= SOCKET =================

const token = localStorage.getItem("token");

const socket = new WebSocket(
    `ws://${window.location.host}/ws/incidentes/?token=${token}`
);


socket.onmessage = function(e){

    const data = JSON.parse(e.data);

    // ðŸ”” Si cambiÃ³ un catÃ¡logo â†’ recargar combos
    if(data.accion === "catalogo_actualizado"){
        console.log("CatÃ¡logo actualizado:", data.tabla);
        cargarDDL();
    }
};




let incidenteActual = null;
let modalAsignar;

document.addEventListener("DOMContentLoaded",()=>{

  modalAsignar = new bootstrap.Modal(
      document.getElementById("modalAsignar")
  );
});

async function abrirAsignacion(id){

    incidenteActual = id;

    const res = await authFetch(
        "/api/recursos/disponibles/"
    );

    const data = await res.json();

    let html = "";

data.forEach(r=>{

html += `
<div class="col-md-6">
  <div class="form-check border p-2 rounded">
    <input 
      class="form-check-input"
      type="checkbox"
      id="rec${r.id}"
      value="${r.id}">

    <label class="form-check-label" for="rec${r.id}">
      <strong>${r.nombre}</strong><br>
      <small>${r.tipo_nombre}</small>
    </label>
  </div>
</div>`;
});


    listaRecursos.innerHTML = html;

    modalAsignar.show();
}




async function confirmarAsignacion(){

    const checks = 
      document.querySelectorAll("#listaRecursos input:checked");

    let arr = [];

    checks.forEach(c=>arr.push(c.value));

    if(arr.length == 0){
        alert("Seleccione al menos un recurso");
        return;
    }

    await authFetch(
      `/api/incidentes/${incidenteActual}/asignar/`,
      {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ recursos: arr })
      }
    );

    alert("Recursos asignados");

    modalAsignar.hide();   // ðŸ‘ˆ ASÃ SE CIERRA
}





// ================= CARGAR DROPDOWNS =================

async function cargarDDL(){

    const [r1, r2, r3] = await Promise.all([
        authFetch("/api/catalogos/tipo-incidente/"),
        authFetch("/api/catalogos/severidad/"),
        authFetch("/api/catalogos/estado-incidente/")
    ]);

    const tipos = await r1.json();
    const sevs = await r2.json();
    const ests = await r3.json();

    // limpiar
    tipo.innerHTML = "";
    severidad.innerHTML = "";
    estado.innerHTML = "";

    // llenar
    tipos.forEach(x=>{
        tipo.innerHTML += `
        <option value="${x.id}">${x.nombre}</option>`;
    });

    sevs.forEach(x=>{
        severidad.innerHTML += `
        <option value="${x.id}">${x.nombre}</option>`;
    });

    ests.forEach(x=>{
        estado.innerHTML += `
        <option value="${x.id}">${x.nombre}</option>`;
    });
}

// ================= REGISTRAR =================

async function crearIncidente(){

    const form = new FormData();
    form.append("tipo", tipo.value);
    form.append("severidad", severidad.value);
    form.append("estado", estado.value);
    form.append("descripcion", desc.value);
    form.append("latitud", lat.value);
    form.append("longitud", lng.value);

    if(evidencia.files.length>0){
        form.append("evidencia", evidencia.files[0]);
    }

    await authFetch("/api/incidentes/",{
        method:"POST",
        body: form
    });

    alert("Incidente registrado");
    cargarIncidentes();
}

// ================= LISTAR =================

async function cargarIncidentes(){

    const res = await authFetch("/api/incidentes/");
    const data = await res.json();

    tabla.innerHTML="";
    data.forEach(x=>{
        tabla.innerHTML+=`
        <tr>
            <td>${x.id}</td>
            <td>${x.tipo_nombre}</td>
            <td>${x.severidad_nombre}</td>
            <td>${x.estado_nombre}</td>
            <td>${x.latitud}, ${x.longitud}</td>
<td>
  <button 
    class="btn btn-sm btn-outline-primary"
    onclick="abrirAsignacion(${x.id})">
    ðŸ§° Asignar
  </button>

  <button 
    class="btn btn-sm btn-outline-warning"
    onclick="cambiarEstado(${x.id})">
    ðŸ”„
  </button>
</td>


        </tr>`;
    });
}

// ================= CAMBIAR ESTADO =================

async function cambiarEstado(id){

    const nuevo = prompt("Ingrese ID nuevo estado:");

    if(!nuevo) return;

    await authFetch(`/api/incidentes/${id}/estado/`,{
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
            estado: nuevo
        })
    });

    cargarIncidentes();
}

// ================= INIT =================

document.addEventListener("DOMContentLoaded",()=>{
    cargarDDL();
    cargarIncidentes();
});
</script>

{% endblock %}

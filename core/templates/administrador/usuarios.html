{% extends 'base.html' %}
{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card card-custom">
            <div class="card-header card-header-custom">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Gestión de Usuarios</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-custom mb-4" onclick="mostrarFormulario()">
                    <i class="fas fa-plus-circle me-2"></i>Nuevo Usuario
                </button>
                <div id="formUsuario" style="display:none" class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">Crear Nuevo Usuario</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Usuario</label>
                                <input id="username" class="form-control" placeholder="Nombre de usuario">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Email</label>
                                <input id="email" class="form-control" placeholder="correo@ejemplo.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Contraseña</label>
                                <input id="password" class="form-control" type="password" placeholder="Contraseña">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Rol</label>
                                <select id="rol" class="form-select">
                                    <option value="admin">Administrador</option>
                                    <option value="operador">Operador</option>
                                    <option value="rescatista">Rescatista</option>
                                    <option value="auditor">Auditor</option>
                                </select>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="crearUsuario()">
                                <i class="fas fa-save me-2"></i>Guardar
                            </button>
                            <button class="btn btn-secondary" onclick="ocultarFormulario()">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </button>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tablaUsuarios">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyUsuarios"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
toastr.options = {
    "closeButton": true,
    "progressBar": true,
    "positionClass": "toast-top-right",
    "timeOut": "3000"
};

function formatearRol(rol) {
    const colores = {
        'admin': 'danger',
        'operador': 'primary',
        'rescatista': 'success',
        'auditor': 'warning'
    };
    const color = colores[rol] || 'secondary';
    return `<span class="badge bg-${color}">${rol}</span>`;
}

async function cargarUsuarios() {
    try {
        const res = await authFetch("/api/usuarios/");
        
        if (!res.ok) {
            throw new Error(`Error ${res.status}`);
        }
        
        const data = await res.json();
        const tbody = document.getElementById("tbodyUsuarios");
        tbody.innerHTML = "";
        
        if (data.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="fas fa-users-slash fa-2x mb-2"></i><br>
                        No hay usuarios registrados
                    </td>
                </tr>`;
            return;
        }
        
        data.forEach(u => {
            const rolFormateado = formatearRol(u.rol);
            const estadoBadge = u.activo 
                ? '<span class="badge bg-success">Activo</span>'
                : '<span class="badge bg-danger">Inactivo</span>';
            
            tbody.innerHTML += `
            <tr>
                <td>${u.id}</td>
                <td><strong>${u.username}</strong></td>
                <td>${u.email}</td>
                <td>${rolFormateado}</td>
                <td>${estadoBadge}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        ${u.activo
                            ? `<button class="btn btn-outline-danger" onclick="desactivarUsuario(${u.id})" title="Desactivar">
                                  <i class="fas fa-user-slash"></i>
                               </button>`
                            : `<button class="btn btn-outline-success" onclick="activarUsuario(${u.id})" title="Activar">
                                  <i class="fas fa-user-check"></i>
                               </button>`}
                    </div>
                </td>
            </tr>`;
        });
        
        console.log(`${data.length} usuarios cargados`);
        
    } catch (error) {
        console.error("Error cargando usuarios:", error);
        toastr.error("No se pudo cargar la lista de usuarios");
    }
}

async function crearUsuario() {
    const usernameVal = document.getElementById("username").value.trim();
    const emailVal = document.getElementById("email").value.trim();
    const passwordVal = document.getElementById("password").value.trim();
    const rolVal = document.getElementById("rol").value;

    if (!usernameVal) {
        toastr.warning("Ingrese un nombre de usuario");
        document.getElementById("username").focus();
        return;
    }

    if (!emailVal) {
        toastr.warning("Ingrese un email");
        document.getElementById("email").focus();
        return;
    }

    if (!passwordVal) {
        toastr.warning("Ingrese una contraseña");
        document.getElementById("password").focus();
        return;
    }

    if (passwordVal.length < 6) {
        toastr.warning("La contraseña debe tener al menos 6 caracteres");
        document.getElementById("password").focus();
        return;
    }

    const body = {
        username: usernameVal,
        email: emailVal,
        password: passwordVal,
        rol: rolVal
    };

    try {
        const response = await authFetch("/api/usuarios/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });
        
        if (response.ok) {
            toastr.success("Usuario creado correctamente");
            
            document.getElementById("username").value = "";
            document.getElementById("email").value = "";
            document.getElementById("password").value = "";
            document.getElementById("rol").value = "operador";
            
            ocultarFormulario();
            
            cargarUsuarios();
        } else {
            const errorData = await response.json();
            const mensajeError = errorData.error || errorData.detail || "Error al crear usuario";
            toastr.error(mensajeError);
        }
    } catch (error) {
        console.error("Error:", error);
        toastr.error("Error de conexión");
    }
}

async function desactivarUsuario(id) {
    try {
        const response = await authFetch(`/api/usuarios/${id}/`, {
            method: "DELETE"
        });
        
        if (response.ok) {
            toastr.success("Usuario desactivado");
            cargarUsuarios();
        } else {
            const errorData = await response.json();
            const mensajeError = errorData.error || errorData.detail || "Error al desactivar";
            toastr.error(mensajeError);
        }
    } catch (error) {
        console.error("Error:", error);
        toastr.error("Error de conexión");
    }
}

async function activarUsuario(id) {
    try {
        const response = await authFetch(`/api/usuarios/${id}/`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ activo: true })
        });
        
        if (response.ok) {
            toastr.success("Usuario activado");
            cargarUsuarios();
        } else {
            const errorData = await response.json();
            const mensajeError = errorData.error || errorData.detail || "Error al activar";
            toastr.error(mensajeError);
        }
    } catch (error) {
        console.error("Error:", error);
        toastr.error("Error de conexión");
    }
}

function mostrarFormulario() {
    document.getElementById('formUsuario').style.display = 'block';
    document.getElementById('username').focus();
}

function ocultarFormulario() {
    document.getElementById('formUsuario').style.display = 'none';
    document.getElementById("username").value = "";
    document.getElementById("email").value = "";
    document.getElementById("password").value = "";
    document.getElementById("rol").value = "operador";
}

function verificarPermisos() {
    const role = getUserRole();
    if (role !== 'admin') {
        toastr.error("Acceso solo para administradores");
        setTimeout(() => {
            window.location.href = "/";
        }, 1500);
        return false;
    }
    return true;
}

document.addEventListener("DOMContentLoaded", () => {
    if (verificarPermisos()) {
        cargarUsuarios();
    }
});
</script>

<style>
.table-dark {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.table-dark th {
    border-bottom: none;
}

.btn-outline-danger:hover {
    color: white;
    background-color: #dc3545;
    border-color: #dc3545;
}

.btn-outline-success:hover {
    color: white;
    background-color: #28a745;
    border-color: #28a745;
}

.badge {
    font-size: 0.85em;
    padding: 0.4em 0.8em;
}

#formUsuario {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

{% endblock %}
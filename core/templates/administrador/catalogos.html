{% extends 'base.html' %}
{% load static %}
{% block content %}
<h2>Gesti칩n de Cat치logos</h2>
<hr>
<div class="tabs">
    <button class="tab-button active" onclick="showTab('tipoIncidente')">Tipo de Incidente</button>
    <button class="tab-button" onclick="showTab('severidad')">Severidad</button>
    <button class="tab-button" onclick="showTab('estadoIncidente')">Estado Incidente</button>
    <button class="tab-button" onclick="showTab('recursos')">Recursos</button>
    <button class="tab-button" onclick="showTab('tipoRecurso')">Tipo de Recurso</button>
    <button class="tab-button" onclick="showTab('estadoRecurso')">Estado de Recurso</button>
</div>
<div id="tipoIncidente" class="tab-content active">
    <div class="form-section">
        <h3>Tipo de Incidente</h3>
        <input id="ti_nombre" placeholder="Nombre">
        <input id="ti_desc" placeholder="Descripci칩n">
        <button onclick="crearTipoIncidente()" class="admin-only">Guardar</button>
    </div>
    <div class="table-container">
        <table id="tablaTI" class="display" width="100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Descripci칩n</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<div id="severidad" class="tab-content">
    <div class="form-section">
        <h3>Severidad</h3>
        <input id="sev_nombre" placeholder="Nombre">
        <input id="sev_nivel" type="number" placeholder="Nivel">
        <button onclick="crearSeveridad()">Guardar</button>
    </div>
    <div class="table-container">
        <table id="tablaSev" class="display" width="100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Nivel</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="estadoIncidente" class="tab-content">
    <div class="form-section">
        <h3>Estado Incidente</h3>
        <input id="est_nombre" placeholder="Nombre">
        <button onclick="crearEstado()">Guardar</button>
    </div>
    <div class="table-container">
        <table id="tablaEst" class="display" width="100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="recursos" class="tab-content">
    <div class="form-section">
        <h3>Recursos</h3>
        <input id="rec_nombre" placeholder="Nombre">
        <select id="rec_tipo"></select>
        <select id="rec_estado"></select>
        <input id="rec_capacidad" type="text" placeholder="Capacidad">
        <button onclick="crearRecurso()">Guardar</button>
    </div>
    <div class="table-container">
        <table id="tablaRec" class="display" width="100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Capacidad</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="tipoRecurso" class="tab-content">
    <div class="form-section">
        <h3>Tipo de Recurso</h3>
        <input id="tr_nombre" placeholder="Nombre">
        <input id="tr_desc" placeholder="Descripci칩n">
        <button onclick="crearTipoRecurso()">Guardar</button>
    </div>
    <div class="table-container">
        <table id="tablaTR" class="display" width="100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Descripci칩n</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="estadoRecurso" class="tab-content">
    <div class="form-section">
        <h3>Estado de Recurso</h3>
        <input id="er_nombre" placeholder="Nombre">
        <button onclick="crearEstadoRecurso()">Guardar</button>
    </div>
    <div class="table-container">
        <table id="tablaER" class="display" width="100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

<style>
.tabs {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.tab-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    margin: 5px;
    cursor: pointer;
    border-radius: 25px;
    font-size: 16px;
    font-weight: bold;
    transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    position: relative;
    overflow: hidden;
}

.tab-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.tab-button:hover::before {
    left: 100%;
}

.tab-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.tab-button.active {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
}

.tab-content {
    display: none;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.tab-content.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
}

.form-section {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    animation: slideIn 0.6s ease-out;
}

.form-section h3 {
    margin-top: 0;
    color: #333;
    font-size: 24px;
    text-align: center;
}

.form-section input, .form-section select, .form-section button {
    margin: 10px 5px;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ddd;
    font-size: 16px;
}

.form-section button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.form-section button:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.table-container {
    background: white;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    animation: fadeInUp 0.8s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-50px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes zoomIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.dataTables_wrapper {
    font-family: 'Arial', sans-serif;
}

.dataTables_length, .dataTables_filter, .dataTables_info, .dataTables_paginate {
    margin-bottom: 10px;
}

.dt-buttons {
    margin-bottom: 10px;
}

.dt-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    border: none !important;
    padding: 8px 16px !important;
    border-radius: 20px !important;
    margin: 2px !important;
    transition: all 0.3s ease !important;
}

.dt-button:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2) !important;
}
</style>

<script>
let dataTableTI = null;
let dataTableSev = null;
let dataTableEst = null;
let dataTableTR = null;
let dataTableER = null;
let dataTableRec = null;

toastr.options = {
    "closeButton": true,
    "progressBar": true,
    "positionClass": "toast-top-right",
    "timeOut": "3000"
};

function showTab(tabId) {
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.classList.remove('active');
    });
    const buttons = document.querySelectorAll('.tab-button');
    buttons.forEach(button => {
        button.classList.remove('active');
    });
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
}

async function cargarER(){
    try {
        const res = await authFetch("/api/catalogos/estado-recurso/");
        const data = await res.json();

        let rows = [];
        data.forEach(x=>{
            rows.push([
                x.id,
                `<span contenteditable="true" id="ern${x.id}">${x.nombre}</span>`,
                `<button onclick="editarER(${x.id})" class="admin-only">九勇</button>
                 <button onclick="eliminarER(${x.id})" class="admin-only">游딈</button>`
            ]);
        });
        
        if (dataTableER) {
            dataTableER.clear();
            dataTableER.rows.add(rows);
            dataTableER.draw();
        } else {
            dataTableER = $('#tablaER').DataTable({
                data: rows,
                columns: [
                    { title: "ID" },
                    { title: "Nombre" },
                    { title: "Acciones" }
                ],
                dom: 'Bfrtip',
                buttons: [
                    'csv', 'excel', 'pdf', 'print'
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
                },
                pageLength: 10,
                responsive: true
            });
        }
        
    } catch (error) {
        console.error('Error cargando estados de recurso:', error);
        toastr.error('Error al cargar estados de recurso');
    }
}

async function crearEstadoRecurso(){
    try {
        if (!er_nombre.value.trim()) {
            toastr.warning("El nombre es requerido");
            return;
        }

        await authFetch("/api/catalogos/estado-recurso/",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                nombre: er_nombre.value
            })
        });

        er_nombre.value="";
        toastr.success("Estado de recurso creado");
        await cargarER();
        await cargarCombosRecursos();
        await cargarRecursos();
    } catch (error) {
        toastr.error("Error al crear el estado de recurso");
    }
}

async function editarER(id){
    try {
        const nuevoNombre = document.getElementById("ern"+id).innerText.trim();
        if (!nuevoNombre) {
            toastr.warning("El nombre no puede estar vac칤o");
            return;
        }

        await authFetch(`/api/catalogos/estado-recurso/${id}/`,{
            method:"PUT",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                nombre: nuevoNombre
            })
        });

        toastr.success("Estado de recurso actualizado");
        await cargarER();
        await cargarCombosRecursos();
        await cargarRecursos();
    } catch (error) {
        toastr.error("Error al actualizar el estado de recurso");
    }
}

async function eliminarER(id){
    try {
        await authFetch(`/api/catalogos/estado-recurso/${id}/`,{
            method:"DELETE"
        });

        toastr.success("Estado de recurso eliminado");
        await cargarER();
        await cargarCombosRecursos();
        await cargarRecursos();
    } catch (error) {
        toastr.error("Error al eliminar el estado de recurso");
    }
}

async function cargarTR(){
    try {
        const res = await authFetch("/api/catalogos/tipo-recurso/");
        const data = await res.json();

        let rows = [];
        data.forEach(x=>{
            rows.push([
                x.id,
                `<span contenteditable="true" id="trn${x.id}">${x.nombre}</span>`,
                `<span contenteditable="true" id="trd${x.id}">${x.descripcion||""}</span>`,
                `<button onclick="editarTR(${x.id})" class="admin-only">九勇</button>
                 <button onclick="eliminarTR(${x.id})" class="admin-only">游딈</button>`
            ]);
        });
        
        if (dataTableTR) {
            dataTableTR.clear();
            dataTableTR.rows.add(rows);
            dataTableTR.draw();
        } else {
            dataTableTR = $('#tablaTR').DataTable({
                data: rows,
                columns: [
                    { title: "ID" },
                    { title: "Nombre" },
                    { title: "Descripci칩n" },
                    { title: "Acciones" }
                ],
                dom: 'Bfrtip',
                buttons: [
                    'csv', 'excel', 'pdf', 'print'
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
                },
                pageLength: 10,
                responsive: true
            });
        }
        
    } catch (error) {
        console.error('Error cargando tipos de recurso:', error);
        toastr.error('Error al cargar tipos de recurso');
    }
}

async function crearTipoRecurso(){
    try {
        if (!tr_nombre.value.trim()) {
            toastr.warning("El nombre es requerido");
            return;
        }

        if (!tr_desc.value.trim()) {
            toastr.warning("La descripci칩n es requerida");
            return;
        }

        await authFetch("/api/catalogos/tipo-recurso/",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                nombre: tr_nombre.value,
                descripcion: tr_desc.value
            })
        });

        tr_nombre.value="";
        tr_desc.value="";
        toastr.success("Tipo de recurso creado");
        await cargarTR();
        await cargarCombosRecursos();
        await cargarRecursos();
    } catch (error) {
        toastr.error("Error al crear el tipo de recurso");
    }
}

async function editarTR(id){
    try {
        const nuevoNombre = document.getElementById("trn"+id).innerText.trim();
        const nuevaDesc = document.getElementById("trd"+id).innerText.trim();
        
        if (!nuevoNombre) {
            toastr.warning("El nombre no puede estar vac칤o");
            return;
        }

        if (!nuevaDesc) {
            toastr.warning("La descripci칩n no puede estar vac칤a");
            return;
        }

        await authFetch(`/api/catalogos/tipo-recurso/${id}/`,{
            method:"PUT",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                nombre: nuevoNombre,
                descripcion: nuevaDesc
            })
        });

        toastr.success("Tipo de recurso actualizado");
        await cargarTR();
        await cargarCombosRecursos();
        await cargarRecursos();
    } catch (error) {
        toastr.error("Error al actualizar el tipo de recurso");
    }
}

async function eliminarTR(id){
    try {
        await authFetch(`/api/catalogos/tipo-recurso/${id}/`,{
            method:"DELETE"
        });

        toastr.success("Tipo de recurso eliminado");
        await cargarTR();
        await cargarCombosRecursos();
        await cargarRecursos();
    } catch (error) {
        toastr.error("Error al eliminar el tipo de recurso");
    }
}


async function cargarCombosRecursos(){
    try {
        const [r1,r2] = await Promise.all([
            authFetch("/api/catalogos/tipo-recurso/"),
            authFetch("/api/catalogos/estado-recurso/")
        ]);

        const tipos = await r1.json();
        const ests = await r2.json();

        rec_tipo.innerHTML="";
        rec_estado.innerHTML="";

        tipos.forEach(x=>{
            rec_tipo.innerHTML+=`<option value="${x.id}">${x.nombre}</option>`;
        });

        ests.forEach(x=>{
            rec_estado.innerHTML+=`<option value="${x.id}">${x.nombre}</option>`;
        });

    } catch (error) {
        console.error('Error cargando combos de recursos:', error);
    }
}

async function cargarRecursos(){
    try {
        const res = await authFetch("/api/recursos/");
        const data = await res.json();

        let rows = [];
        data.forEach(x=>{
            rows.push([
                x.id,
                `<span contenteditable="true" id="rn${x.id}">${x.nombre}</span>`,
                x.tipo_nombre,
                x.estado_nombre,
                `<span contenteditable="true" id="rc${x.id}">${x.capacidad}</span>`,
                `<button onclick="editarRecurso(${x.id})" class="admin-only">九勇</button>
                 <button onclick="eliminarRecurso(${x.id})" class="admin-only">游딈</button>`
            ]);
        });
        
        if (dataTableRec) {
            dataTableRec.clear();
            dataTableRec.rows.add(rows);
            dataTableRec.draw();
        } else {
            dataTableRec = $('#tablaRec').DataTable({
                data: rows,
                columns: [
                    { title: "ID" },
                    { title: "Nombre" },
                    { title: "Tipo" },
                    { title: "Estado" },
                    { title: "Capacidad" },
                    { title: "Acciones" }
                ],
                dom: 'Bfrtip',
                buttons: [
                    'csv', 'excel', 'pdf', 'print'
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
                },
                pageLength: 10,
                responsive: true
            });
        }
        
    } catch (error) {
        console.error('Error cargando recursos:', error);
        toastr.error('Error al cargar recursos');
    }
}

async function crearRecurso(){
    try {
        if (!rec_nombre.value.trim()) {
            toastr.warning("El nombre es requerido");
            return;
        }

        if (!rec_tipo.value) {
            toastr.warning("El tipo es requerido");
            return;
        }

        if (!rec_estado.value) {
            toastr.warning("El estado es requerido");
            return;
        }

        if (!rec_capacidad.value.trim()) {
            toastr.warning("La capacidad es requerida");
            return;
        }

        await authFetch("/api/recursos/",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                nombre: rec_nombre.value,
                tipo: rec_tipo.value,
                estado: rec_estado.value,
                capacidad: rec_capacidad.value
            })
        });

        rec_nombre.value="";
        rec_capacidad.value="";
        toastr.success("Recurso creado");
        await cargarRecursos();
    } catch (error) {
        toastr.error("Error al crear el recurso");
    }
}

async function editarRecurso(id){
    try {
        const nuevoNombre = document.getElementById("rn"+id).innerText.trim();
        const nuevaCapacidad = document.getElementById("rc"+id).innerText.trim();
        
        if (!nuevoNombre) {
            toastr.warning("El nombre no puede estar vac칤o");
            return;
        }

        if (!nuevaCapacidad) {
            toastr.warning("La capacidad no puede estar vac칤a");
            return;
        }

        await authFetch(`/api/recursos/${id}/`,{
            method:"PUT",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                nombre: nuevoNombre,
                capacidad: nuevaCapacidad
            })
        });

        toastr.success("Recurso actualizado");
        await cargarRecursos();
    } catch (error) {
        toastr.error("Error al actualizar el recurso");
    }
}

async function eliminarRecurso(id){
    try {
        await authFetch(`/api/recursos/${id}/`,{
            method:"DELETE"
        });

        toastr.success("Recurso eliminado");
        await cargarRecursos();
    } catch (error) {
        toastr.error("Error al eliminar el recurso");
    }
}


async function cargarTI(){
    try {
        const res = await authFetch("/api/catalogos/tipo-incidente/");
        const data = await res.json();

        let rows = [];
        data.forEach(x=>{
            rows.push([
                x.id,
                `<span contenteditable="true" id="tin${x.id}">${x.nombre}</span>`,
                `<span contenteditable="true" id="tid${x.id}">${x.descripcion}</span>`,
                `<button onclick="editarTI(${x.id})" class="admin-only">九勇</button>
                 <button onclick="eliminarTI(${x.id})" class="admin-only">游딈</button>`
            ]);
        });
        
        if (dataTableTI) {
            dataTableTI.clear();
            dataTableTI.rows.add(rows);
            dataTableTI.draw();
        } else {
            dataTableTI = $('#tablaTI').DataTable({
                data: rows,
                columns: [
                    { title: "ID" },
                    { title: "Nombre" },
                    { title: "Descripci칩n" },
                    { title: "Acciones" }
                ],
                dom: 'Bfrtip',
                buttons: [
                    'csv', 'excel', 'pdf', 'print'
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
                },
                pageLength: 10,
                responsive: true
            });
        }
        
    } catch (error) {
        console.error('Error cargando tipos de incidente:', error);
        toastr.error('Error al cargar tipos de incidente');
    }
}

async function crearTipoIncidente(){
    try {
        if (!ti_nombre.value.trim()) {
            toastr.warning("El nombre es requerido");
            return;
        }
        if (!ti_desc.value.trim()) {
            toastr.warning("La descripci칩n es requerida");
            return;
        }
        
        await authFetch("/api/catalogos/tipo-incidente/",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                nombre: ti_nombre.value,
                descripcion: ti_desc.value
            })
        });
        
        ti_nombre.value="";
        ti_desc.value="";
        toastr.success("Tipo de incidente creado");
        await cargarTI();
    } catch (error) {
        toastr.error("Error al crear tipo de incidente");
    }
}

async function editarTI(id){
    try {
        const nuevoNombre = document.getElementById("tin"+id).innerText.trim();
        const nuevaDesc = document.getElementById("tid"+id).innerText.trim();
        
        if (!nuevoNombre) {
            toastr.warning("El nombre no puede estar vac칤o");
            return;
        }

        if (!nuevaDesc) {
            toastr.warning("La descripci칩n no puede estar vac칤a");
            return;
        }

        await authFetch(`/api/catalogos/tipo-incidente/${id}/`,{
            method:"PUT",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                nombre: nuevoNombre,
                descripcion: nuevaDesc
            })
        });
        
        toastr.success("Tipo de incidente actualizado");
        await cargarTI();
    } catch (error) {
        toastr.error("Error al actualizar tipo de incidente");
    }
}

async function eliminarTI(id){
    try {
        await authFetch(`/api/catalogos/tipo-incidente/${id}/`,{
            method:"DELETE"
        });
        
        toastr.success("Tipo de incidente eliminado");
        await cargarTI();
    } catch (error) {
        toastr.error("Error al eliminar tipo de incidente");
    }
}


async function cargarSev(){
    try {
        const res = await authFetch("/api/catalogos/severidad/");
        const data = await res.json();

        let rows = [];
        data.forEach(x=>{
            rows.push([
                x.id,
                `<span contenteditable="true" id="sn${x.id}">${x.nombre}</span>`,
                `<span contenteditable="true" id="sl${x.id}">${x.nivel}</span>`,
                `<button onclick="editarSev(${x.id})" class="admin-only">九勇</button>
                 <button onclick="eliminarSev(${x.id})" class="admin-only">游딈</button>`
            ]);
        });
        
        if (dataTableSev) {
            dataTableSev.clear();
            dataTableSev.rows.add(rows);
            dataTableSev.draw();
        } else {
            dataTableSev = $('#tablaSev').DataTable({
                data: rows,
                columns: [
                    { title: "ID" },
                    { title: "Nombre" },
                    { title: "Nivel" },
                    { title: "Acciones" }
                ],
                dom: 'Bfrtip',
                buttons: [
                    'csv', 'excel', 'pdf', 'print'
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
                },
                pageLength: 10,
                responsive: true
            });
        }
        
    } catch (error) {
        console.error('Error cargando severidades:', error);
        toastr.error('Error al cargar severidades');
    }
}

async function crearSeveridad(){
    try {
        if (!sev_nombre.value.trim()) {
            toastr.warning("El nombre es requerido");
            return;
        }
        if (!sev_nivel.value) {
            toastr.warning("El nivel es requerido");
            return;
        }
        
        await authFetch("/api/catalogos/severidad/",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                nombre: sev_nombre.value,
                nivel: sev_nivel.value
            })
        });
        
        sev_nombre.value="";
        sev_nivel.value="";
        toastr.success("Severidad creada");
        await cargarSev();
    } catch (error) {
        toastr.error("Error al crear severidad");
    }
}

async function editarSev(id){
    try {
        const nuevoNombre = document.getElementById("sn"+id).innerText.trim();
        const nuevoNivel = document.getElementById("sl"+id).innerText.trim();
        
        if (!nuevoNombre) {
            toastr.warning("El nombre no puede estar vac칤o");
            return;
        }

        if (!nuevoNivel || isNaN(nuevoNivel)) {
            toastr.warning("El nivel debe ser un n칰mero v치lido");
            return;
        }

        await authFetch(`/api/catalogos/severidad/${id}/`,{
            method:"PUT",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                nombre: nuevoNombre,
                nivel: parseInt(nuevoNivel)
            })
        });
        
        toastr.success("Severidad actualizada");
        await cargarSev();
    } catch (error) {
        toastr.error("Error al actualizar severidad");
    }
}

async function eliminarSev(id){
    try {
        await authFetch(`/api/catalogos/severidad/${id}/`,{
            method:"DELETE"
        });
        
        toastr.success("Severidad eliminada");
        await cargarSev();
    } catch (error) {
        toastr.error("Error al eliminar severidad");
    }
}


async function cargarEst(){
    try {
        const res = await authFetch("/api/catalogos/estado-incidente/");
        const data = await res.json();

        let rows = [];
        data.forEach(x=>{
            rows.push([
                x.id,
                `<span contenteditable="true" id="en${x.id}">${x.nombre}</span>`,
                `<button onclick="editarEstado(${x.id})" class="admin-only">九勇</button>
                 <button onclick="eliminarEstado(${x.id})" class="admin-only">游딈</button>`
            ]);
        });
        
        if (dataTableEst) {
            dataTableEst.clear();
            dataTableEst.rows.add(rows);
            dataTableEst.draw();
        } else {
            dataTableEst = $('#tablaEst').DataTable({
                data: rows,
                columns: [
                    { title: "ID" },
                    { title: "Nombre" },
                    { title: "Acciones" }
                ],
                dom: 'Bfrtip',
                buttons: [
                    'csv', 'excel', 'pdf', 'print'
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
                },
                pageLength: 10,
                responsive: true
            });
        }
        
    } catch (error) {
        console.error('Error cargando estados de incidente:', error);
        toastr.error('Error al cargar estados de incidente');
    }
}

async function crearEstado(){
    try {
        if (!est_nombre.value.trim()) {
            toastr.warning("El nombre es requerido");
            return;
        }
        
        await authFetch("/api/catalogos/estado-incidente/",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                nombre: est_nombre.value
            })
        });
        
        est_nombre.value="";
        toastr.success("Estado de incidente creado");
        await cargarEst();
    } catch (error) {
        toastr.error("Error al crear estado de incidente");
    }
}

async function editarEstado(id){
    try {
        const nuevoNombre = document.getElementById("en"+id).innerText.trim();
        
        if (!nuevoNombre) {
            toastr.warning("El nombre no puede estar vac칤o");
            return;
        }

        await authFetch(`/api/catalogos/estado-incidente/${id}/`,{
            method:"PUT",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
                nombre: nuevoNombre
            })
        });
        
        toastr.success("Estado de incidente actualizado");
        await cargarEst();
    } catch (error) {
        toastr.error("Error al actualizar estado de incidente");
    }
}

async function eliminarEstado(id){
    try {
        await authFetch(`/api/catalogos/estado-incidente/${id}/`,{
            method:"DELETE"
        });

        toastr.success("Estado de incidente eliminado");
        await cargarEst();
    } catch (error) {
        toastr.error("Error al eliminar el estado de incidente");
    }
}

document.addEventListener("DOMContentLoaded", async ()=>{
    try {
        await Promise.all([
            cargarTI(),
            cargarSev(),
            cargarEst(),
            cargarTR(),
            cargarER(),
            cargarCombosRecursos(),
            cargarRecursos()
        ]);
        
        console.log('Cat치logos cargados');
        
    } catch (error) {
        console.error('Error inicializando cat치logos:', error);
        toastr.error('Error al cargar cat치logos');
    }
});
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

{% endblock %}